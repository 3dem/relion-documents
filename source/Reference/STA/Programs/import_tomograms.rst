.. _program_tomo_import_tomograms:

relion_tomo_import_tomograms
============================

This program imports a set of tilt series to form a |tomogram_set|.
It is typically the first program to be used when creating a |RELION| tomography data set.
It imports an existing alignment from IMOD_ and the initial CTF parameters from either `CTFFind 
<https://grigoriefflab.umassmed.edu/ctffind4>`_ or `CtfPlotter <https://bio3d.colorado
.edu/imod/doc/man/ctfplotter.html>`_.
Additional parameters, such as the fractional electron dose and the chronological sequence of frames have to be 
supplied by the user.

The tilt series alignment effectively defines an arbitrary 3D coordinate system, as well as a set of projections that map those 3D coordinates to the individual 2D images of the tilt series.
The aim of this program is to translate that alignment into a format readable by |RELION|.
If used successfully, this will produce an equivalent 3D coordinate system inside |RELION| that will allow particle 
positions already defined in an IMOD_ tomogram to be used unchanged.

Optimally, the tilt series would be imported into |RELION| right after alignment, and the particles would be picked 
in a low-magnification tomogram generated by :ref:`program_tomo_reconstruct_tomogram`.
That way, the particle positions would be guaranteed to be correct.

The primary input to `relion_tomo_import_tomograms`_ is a ``.star`` file containing one row for each tilt
series and at least the following columns:

- **rlnTomoImportImodDir**: path to the IMOD_ directory. That directory has to contain the command files used to run IMOD's ``tilt`` and ``newst`` programs. Typically, those are named ``tilt.com`` and ``newst.com``. If those are not their names, then the actual names can be specified using the ``--tc`` and ``--nc`` arguments, respectively. Additional IMOD_ files that are referenced inside those ``.com`` files also need to be present inside the IMOD_ directory.
- **rlnTomoImportCtfFindFile** or **rlnTomoImportCtfPlotterFile**: path to the initial CTF estimate from either CTFFind or CtfPlotter, respectively.
- **rlnTomoTiltSeriesName**: path to the actual tilt series. Note: if the tilt series ends with ``.st``, this needs to be specified with an ``.st:mrc`` ending to tell |RELION| to interpret it as an mrc file.


The following additional columns may be present. If they are not, then the corresponding command line arguments will be used. In that case, they will be identical for all tilt series.

- **rlnTomoName**: the tomogram name. The user is advised to specify a short and meaningful name here, since it will make the data more readable and simplify the resulting directory structure. Names like e.g. ``TS_001`` are recommended. If not specified, the entire path to the tilt series (i.e. the value of ``rlnTomoTiltSeriesName``) will be used instead.
- **rlnTomoImportFractionalDose**: the electron dose corresponding to one tilt image. If omitted, the value of the ``--fd`` argument will be used.
- **rlnTomoImportOrderList**: path to a two-column text file specifying the *chronological* order in which the images were acquired. That file has to contain two numbers per line separated by a comma (and no spaces), where the first number counts up from 1, while the second describes the sequence of tilt angles. To determine the sequence of tilt images, the program will look for the closest tilt angle for each image (as stored in the ``.tlt`` file). This approach can deal with frames missing from the tilt series. If not specified in the ``.star`` file, the ``--ol`` input argument will be used.
- **rlnOpticsGroupName**: an arbitrary name for an optics group. This allows the set of tilt series to be separated into subsets that share the same optical aberrations. This is useful if the data have been collected in multiple sessions that might exhibit different aberrations. If omitted, all tilt series will be assigned to the same default optics group.
- **rlnTomoImportOffset<X/Y/Z>**: an arbitrary offset to the 3D coordinate system. This is useful if particles have already been picked in tomograms that have been cropped after reconstruction by IMOD_. If the IMOD-internal ``SHIFT`` command has been used to apply offsets, then this will be handled internally and does *not* need to be specified here. If omitted, then the values of the ``--off<x/y/z>`` command line arguments will be used instead (which default to 0).
- **rlnTomoImportCulledFile**: output file name for a new tilt series with the excluded frames missing. This is only needed if tilt images have been excluded using IMOD's ``EXCLUDE``, ``EXCLUDELIST`` or ``EXCLUDELIST2`` commands. In that case, this becomes a mandatory parameter.


General program arguments:
--------------------------

- ``--i``: path to the input .star file.
- ``--t``: path to an optional input |tomogram_set| . If specified, the imported tomograms will be added to that set.
- ``--hand``: the handedness of the tilt geometry. The value of this parameter is either +1 or -1, and it describes whether the focus increases or decreases as a function of Z distance. It has to be determined experimentally. In our experiments, it has always been -1.


Optics arguments:
-----------------

- ``--angpix``: the pixel size in Ã….
- ``--voltage``: the voltage in kV.
- ``--Cs``: the spherical aberration in mm.
- ``--Q0``: the amplitude constrast.


Electron dose arguments:
------------------------

- ``--ol``: the file name of a frame-order list file. Corresponds to the ``rlnTomoImportOrderList`` column in the input .star file.
- ``--fd``: The fractional (i.e. per tilt-image) electron dose. Corresponds to the ``rlnTomoImportFractionalDose`` column in the input .star file.


IMOD import arguments:
----------------------

- ``--flipYZ``: if the IMOD_ tomogram has been flipped along Y and Z (i.e. using clip flipyz) after an IMOD reconstruction and before the particles have been picked, this will apply the same transformation to the |RELION| coordinate system. In case a rotation around X was performed (i.e. using clip rotx) this parameter should be used together with ``--flipZ``. This will allow |RELION| to use particle positions defined in the X-rotated tomogram unchanged.
- ``--flipZ``: same as above, in case the Z axis has been flipped. This can be used together with the ``--flipYZ`` option .
- ``--flipAng``: indicates that all angles in the IMOD_ ``.tlt`` file have also been flipped. This is rare.
- ``--off<x/y/z>``: applies an offset to the 3D coordinate system. Equivalent to the ``rlnTomoImportOffse<X/Y/Z>`` column in the input .star file.


Final note: not all IMOD_ options are supported by this program. For example, the X-axis tilt option is not supported.
In case it has been used, we recommend ignoring it and refining the resulting alignment using the program
:ref:`program_tomo_align`.


.. |tomogram_set| replace:: :ref:`tomogram set <sec_sta_tomogram_set>`
.. _IMOD: https://bio3d.colorado.edu/imod